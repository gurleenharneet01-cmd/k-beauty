/**
 * @file Firestore Security Rules for K-Beauty App
 *
 * @description This ruleset enforces a user-ownership model for user profiles, skin reports, and routine steps.
 * The product catalog is publicly readable but only writable by administrators. Analytics event logging is generally open,
 * but can be restricted if necessary.
 *
 * @dataStructure
 * - `/users/{userId}`: Stores user profile information, owned by the user.
 * - `/products/{productId}`: Stores product catalog information, publicly readable, admin-writeable.
 * - `/users/{userId}/skinReports/{skinReportId}`: Stores skin reports, owned by the user.
 * - `/users/{userId}/routineSteps/{routineStepId}`: Stores routine steps, owned by the user.
 * - `/analytics/{eventId}`: Stores analytics events, open access.
 * - `/roles_admin/{userId}`: Determines if a user is an administrator. The existence of the document is all that matters.
 *
 * @keySecurityDecisions
 * - Users can only read and write their own user documents and associated subcollections (skinReports, routineSteps).
 * - The product catalog is publicly readable to allow browsing without authentication.
 * - Only administrators can create, update, or delete products.
 * - Listing of user documents is disallowed.
 * - Analytics event creation is open to facilitate data collection.
 * - The existence of a document in `/roles_admin/{userId}` grants admin privileges.
 *
 * @denormalizationForAuthorization
 * - User ownership is enforced via path-based rules (e.g., `/users/{userId}/skinReports/{skinReportId}`).
 * - Admin status is determined by the existence of a document in the `/roles_admin/{userId}` collection.
 *
 * @structuralSegregation
 * - Private user data is stored under the `/users/{userId}` collection to enforce ownership.
 * - Public product data is stored in the top-level `/products` collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document based on the provided userId.
     * @param {string} userId - The user ID to compare against the request's authentication UID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the existing document.
     * @param {string} userId - The user ID to compare against the resource data's userId.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the user has admin privileges by verifying the existence of a document in `/roles_admin/{userId}`.
     * @returns {boolean} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the `/users/{userId}` collection.
     * @path /users/{userId}
     * @allow (create) - User with matching UID can create their own document.
     * @allow (get) - User with matching UID can get their own document.
     * @allow (update) - User with matching UID can update their own document.
     * @allow (delete) - User with matching UID can delete their own document.
     * @deny (create) - User cannot create a document with a mismatched UID.
     * @deny (get) - User cannot get another user's document.
     * @deny (update) - User cannot update another user's document.
     * @deny (delete) - User cannot delete another user's document.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the `/products/{productId}` collection.
     * @path /products/{productId}
     * @allow (get) - Any user can read product data.
     * @allow (create) - Only admins can create products.
     * @allow (update) - Only admins can update products.
     * @allow (delete) - Only admins can delete products.
     * @deny (create) - Non-admins cannot create products.
     * @deny (update) - Non-admins cannot update products.
     * @deny (delete) - Non-admins cannot delete products.
     * @principle Allows public read access but restricts writes to admins only.
     */
    match /products/{productId} {
      allow get, list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the `/users/{userId}/skinReports/{skinReportId}` collection.
     * @path /users/{userId}/skinReports/{skinReportId}
     * @allow (create) - User with matching UID can create skin reports.
     * @allow (get) - User with matching UID can get their own skin reports.
     * @allow (update) - User with matching UID can update their own skin reports.
     * @allow (delete) - User with matching UID can delete their own skin reports.
     * @deny (create) - User cannot create skin reports for other users.
     * @deny (get) - User cannot get skin reports for other users.
     * @deny (update) - User cannot update skin reports for other users.
     * @deny (delete) - User cannot delete skin reports for other users.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/skinReports/{skinReportId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the `/users/{userId}/routineSteps/{routineStepId}` collection.
     * @path /users/{userId}/routineSteps/{routineStepId}
     * @allow (create) - User with matching UID can create routine steps.
     * @allow (get) - User with matching UID can get their own routine steps.
     * @allow (update) - User with matching UID can update their own routine steps.
     * @allow (delete) - User with matching UID can delete their own routine steps.
     * @deny (create) - User cannot create routine steps for other users.
     * @deny (get) - User cannot get routine steps for other users.
     * @deny (update) - User cannot update routine steps for other users.
     * @deny (delete) - User cannot delete routine steps for other users.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/routineSteps/{routineStepId} {
      allow get, list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the `/analytics/{eventId}` collection.
     * @path /analytics/{eventId}
     * @allow (create) - Any signed-in user can create analytics events.
     * @allow (get) - Any user can read analytics events.
     * @allow (list) - Any user can list analytics events.
     * @deny (update) - No one can update analytics events.
     * @deny (delete) - No one can delete analytics events.
     * @principle Allows open read/write access for analytics event logging.
     */
    match /analytics/{eventId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for the `/roles_admin/{userId}` collection.
     * @path /roles_admin/{userId}
     * @allow (create) - Only accessible via backend functions.
     * @allow (get) - Any signed-in user can check for admin status.
     * @deny (list) - Listing is not allowed
     * @deny (update) - Updates are not allowed
     * @deny (delete) - Deletes are not allowed
     */
     match /roles_admin/{userId} {
       allow get: if isSignedIn();
       allow list: if false;
       allow create: if false;
       allow update: if false;
       allow delete: if false;
     }
  }
}